// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  relationMode = "foreignKeys"
}

// ============================================
// ENUMS - ROLES & PERMISSIONS
// ============================================

enum ChatType {
  DIRECT          // Private 1-to-1 chat
  COMMUNITY       // Community/Cell group chat
  BRANCH_WIDE     // Branch-specific announcement/engagement
  CHURCH_WIDE     // Church-wide announcement/engagement
  GROUP           // Custom group chat (created by admins)
  DEPARTMENT      // Department-specific chat
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  ANNOUNCEMENT
  POLL
  SYSTEM
  SHARED_CONTENT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  SURPRISED
  SAD
  ANGRY
  PRAY
  AMEN
}

enum UserRole {
  SUPER_ADMIN           // System-wide access
  TENANT_ADMIN          // Organization-level access
  ARCHBISHOP            // Highest church leadership
  SENIOR_BISHOP         // Senior ecclesiastical authority
  BISHOP                // Regional church leader
  SHEPHERD              // Community/cell leader
  PASTOR                // Church pastor
  WORKER                // Church worker/volunteer
  COUNSELOR             // Church counselor
  COMMUNITY_LEADER      // Community group leader
  DEPARTMENT_HEAD       // Department manager
  VOLUNTEER_COORDINATOR // Volunteer coordinator
  MEMBER                // Regular member
  GUEST                 // Guest/visitor
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  REJECT
  PUBLISH
  ARCHIVE
  EXPORT
  IMPORT
}

enum FeatureModule {
  // Member Management
  MEMBERS
  MEMBER_REGISTRATION
  MEMBER_DIRECTORY
  MEMBER_SEARCH
  MEMBER_FILTERING
  MEMBER_PROFILE
  MEMBER_STATUS_TRACKING
  
  // Community Management
  COMMUNITIES
  CELL_MANAGEMENT
  MINISTRY_MANAGEMENT
  PROFESSION_MANAGEMENT
  TRIBE_MANAGEMENT
  COMMUNITY_LEADERSHIP
  COMMUNITY_MEETINGS
  
  // Attendance & Tracking
  ATTENDANCE_TRACKING
  BIOMETRIC_ATTENDANCE
  MOBILE_CHECKIN
  VIRTUAL_ATTENDANCE
  ATTENDANCE_REPORTS
  
  // Services & Events
  SERVICES
  EVENTS
  EVENT_REGISTRATION
  EVENT_TICKETING
  TRAVEL_BOOKING
  
  // Leadership & Hierarchy
  LEADERSHIP_HIERARCHY
  LEADERSHIP_APPOINTMENTS
  PROMOTION_REQUESTS
  APPRAISALS
  WORKER_TRANSITIONS
  LEADER_APPROVAL
  
  // Departments & Volunteers
  DEPARTMENTS
  VOLUNTEER_MANAGEMENT
  VOLUNTEER_SHIFTS
  DEPARTMENT_ASSIGNMENTS
  
  // Financial Management
  FINANCIAL_MANAGEMENT
  ONLINE_GIVING
  DONATION_TRACKING
  PLEDGE_MANAGEMENT
  ACCOUNTING_SYSTEM
  TRANSACTION_MANAGEMENT
  PAYMENT_GATEWAY
  FINANCIAL_REPORTS
  DONATION_RECEIPTS
  
  // Loyalty & Gamification
  LOYALTY_PROGRAM
  LOYALTY_POINTS
  MEMBER_BADGES
  COMPETITION_MANAGEMENT
  LEADERBOARD
  TIER_MANAGEMENT
  REWARDS_REDEMPTION
  
  // AI & Training
  AI_TRAINING
  AI_CERTIFICATION
  TRAINING_CONTENT
  CERTIFICATION_MANAGEMENT
  DISCUSSION_PROMPTS
  COMMUNITY_COMPETITIONS
  PREDICTIVE_ANALYTICS
  
  // Broadcasting & Communication
  LIVE_STREAMING
  BROADCAST_MANAGEMENT
  SERMON_MANAGEMENT
  HEADLINING_MANAGEMENT
  AI_VIRTUAL_ASSISTANT
  NEXT_GEN_BROADCASTING
  
  // Content & Communication
  CHATBOT_MANAGEMENT
  PRAYER_REQUESTS
  PRAYER_ENGAGEMENT
  GROUP_MESSAGING
  DIRECT_MESSAGING
  NOTIFICATION_SYSTEM
  EMAIL_MANAGEMENT
  SMS_MANAGEMENT
  
  // Chat & Messaging
  COMMUNITY_CHAT
  BRANCH_WIDE_CHAT
  CHURCH_WIDE_CHAT
  DIRECT_CHAT
  CHAT_MODERATION
  CHAT_ANALYTICS
  
  // Surveys & Feedback
  SURVEYS
  SURVEY_RESPONSES
  FEEDBACK_MANAGEMENT
  
  // B2B & Partnerships
  PARTNER_MANAGEMENT
  DISCOUNT_MANAGEMENT
  LOYALTY_REDEMPTION
  
  // System & Administration
  SYSTEM_ADMIN
  USER_MANAGEMENT
  ROLE_MANAGEMENT
  PERMISSION_MANAGEMENT
  BRANCH_MANAGEMENT
  TENANT_MANAGEMENT
  API_TOKEN_MANAGEMENT
  AUDIT_LOGS
  SETTINGS
  ONBOARDING
  OFFBOARDING
  
  // PWA & Mobile
  PWA_MANAGEMENT
  OFFLINE_SYNC
  MOBILE_APP
  
  // Reports & Analytics
  ANALYTICS
  REPORTING
  DASHBOARD
  HEALTH_SCORING
}

enum PermissionLevel {
  NONE      // No access
  VIEW      // Read-only
  EDIT      // Can create, read, update
  MANAGE    // Can create, read, update, delete
  ADMIN     // Full control including approval and publishing
  SUPER     // System-level control
}

// ============================================
// TENANT & ORGANIZATION STRUCTURE
// ============================================

model Tenant {
  id                    String                    @id @default(cuid())
  name                  String                    // Church/Organization name
  slug                  String                    @unique
  logo                  String?
  description           String?
  email                 String
  phone                 String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  timezone              String                    @default("UTC")
  currency              String                    @default("USD")
  language              String                    @default("en")
  status                String                    @default("active") // active, inactive, suspended
  subscriptionTier      String                    @default("basic") // basic, pro, premium
  
  isBranchEnabled       Boolean                   @default(true)
  mainBranchId          String?                   // Reference to primary branch
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  branches              Branch[]
  members               Member[]
  communities           Community[]
  departments           Department[]
  services              Service[]
  events                Event[]
  transactions          Transaction[]
  aiTrainings           AITraining[]
  loyaltyPrograms       LoyaltyProgram[]
  partners              Partner[]
  broadcastSessions     BroadcastSession[]
  chatbotConversations  ChatbotConversation[]
  prayerRequests        PrayerRequest[]
  discussions           Discussion[]
  competitionsRounds    CompetitionRound[]
  systemAdmins          SystemAdmin[]
  roles                 Role[]
  // Chat relations
  directChats           DirectChat[]
  communityChats        CommunityChat[]
  branchChats           BranchWideChat[]
  churchChats           ChurchWideChat[]
  chatMessages          ChatMessage[]
  messageReactions      MessageReaction[]
  typingIndicators      TypingIndicator[]
  chatReports           ChatReport[]
  
  @@index([slug])
}

model Branch {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  slug                  String
  description           String?
  code                  String                    // Branch code (e.g., HQ, BRANCH-001)
  email                 String?
  phone                 String?
  address               String?
  city                  String?
  state                 String?
  country               String?
  timezone?             String?
  headId                String?                   // Branch pastor/leader
  status                String                    @default("active")
  type                  String                    @default("branch")        // main, branch, satellite
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users                 BranchUser[]
  members               Member[]
  // Chat relations
  chats                 BranchWideChat[]
  
  @@unique([tenantId, slug])
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
}

// ============================================
// ROLE-BASED ACCESS CONTROL (RBAC)
// ============================================

model Role {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  UserRole
  displayName           String
  description           String?
  isDefault             Boolean                   @default(false)
  isSystem              Boolean                   @default(false) // System roles cannot be deleted
  isActive              Boolean                   @default(true)
  priority              Int                       @default(0) // Higher = more privileged
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permissions           RolePermission[]
  users                 User[]
  
  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
  @@index([priority])
}

model RolePermission {
  id                    String                    @id @default(cuid())

  featureModule         FeatureModule
  action                PermissionAction
  level                 PermissionLevel           @default(VIEW)
  allowedBranches       String[]                  @default([]) // Empty = all branches
  allowedDepartments    String[]                  @default([]) // Empty = all departments
  customConditions      Json?                     // Store complex permission logic
  grantedAt             DateTime                  @default(now())
  grantedBy             String?                   // Admin who granted permission
  expiresAt             DateTime?                 // Permission expiration date
  isActive              Boolean                   @default(true)
  notes                 String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  

  
  @@unique([roleId, featureModule, action])
  @@index([roleId])
  @@index([featureModule])
  @@index([isActive])
}

model BranchUser {
  id                    String                    @id @default(cuid())
  branchId              String
  userId                String
  role                  String                    // admin, manager, staff // <--- This field is no longer needed as role is managed by the Role model
  status                String                    @default("active")
  assignmentDate        DateTime                  @default(now())
  isPrimary             Boolean                   @default(false)         // User's primary branch
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  branch                Branch                    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([branchId, userId])
  @@index([branchId])
  @@index([userId])
  @@index([status])
}

// ============================================
// SYSTEM ADMINISTRATION & USER MANAGEMENT
// ============================================

model SystemAdmin {
  id                    String                    @id @default(cuid())
  tenantId              String
  userId                String
  adminLevel            String                    // super_admin, tenant_admin, branch_admin
  permissions           Json                      @default("[]")          // Override permissions
  notes                 String?
  status                String                    @default("active")
  onboardedBy           String?
  offboardedBy          String?
  offboardedAt          DateTime?
  offboardReason        String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs             AuditLog[]
  
  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([adminLevel])
  @@index([status])
}

model User {
  id                    String                    @id @default(cuid())
  email                 String                    @unique
  emailVerified         DateTime?
  password              String?
  firstName             String
  lastName              String
  phone                 String?
  profilePhoto          String?
  
  role                  UserRole                  @default(MEMBER)
  
  status                String                    @default("active")      // active, inactive, suspended, pending, offboarded
  lastLogin             DateTime?
  lastLoginBranch       String?
  twoFactorEnabled      Boolean                   @default(false)
  
  onboardedBy           String?
  onboardedAt           DateTime?
  offboardedBy          String?
  offboardReason        String?
  offboardedAt          DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  roleAssignments       Role[]                    @relation("UserRoles")
  
  member                Member?
  apiTokens             APIToken[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  branchAssignments     BranchUser[]
  systemAdminRole       SystemAdmin?
  leadershipHierarchy   LeadershipHierarchy?
  userPermissions       UserPermissionOverride[]
  // Chat relations
  directChatParticipantOne DirectChat[] @relation("DirectChatParticipantOne")
  directChatParticipantTwo DirectChat[] @relation("DirectChatParticipantTwo")
  communityChatParticipants CommunityChatParticipant[]
  chatMessages          ChatMessage[]
  messageReactions      MessageReaction[]
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@index([offboardedAt])
}

model UserPermissionOverride {
  id                    String                    @id @default(cuid())
  userId                String
  featureModule         FeatureModule
  action                PermissionAction
  level                 PermissionLevel
  grantedBy             String
  reason                String?
  expiresAt             DateTime?
  isActive              Boolean                   @default(true)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, featureModule, action])
  @@index([userId])
  @@index([isActive])
}

model LeadershipHierarchy {
  id                    String                    @id @default(cuid())
  userId                String
  tenantId              String
  title                 String
  // Titles: Archbishop, Senior Bishop, Bishop, Shepherd, Pastor, Worker, Counselor, Community Leader
  
  reportingToId         String?                   // Immediate supervisor
  hierarchy             Json                      @default("[]")          // Full hierarchy chain
  appointmentDate       DateTime                  @default(now())
  status                String                    @default("active")
  certifications        Json?                     // Array of certifications
  trainingCompleted     Boolean                   @default(false)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reportingTo           User?                     @relation("ReportsTo", fields: [reportingToId], references: [id], onDelete: SetNull)
  
  @@unique([userId])
  @@index([tenantId])
  @@index([title])
  @@index([status])
}

// ============================================
// CORE ENTITIES
// ============================================

model Member {
  id                    String                    @id @default(cuid())
  tenantId              String
  branchId              String?                   // Added branch assignment
  userId                String                    @unique
  memberId              String                    @unique             // Custom member ID
  firstName             String
  lastName              String
  email                 String
  phone                 String
  dateOfBirth           DateTime
  gender                String
  location              String
  address               String?
  city                  String?
  state                 String?
  country               String?
  profession            String
  registrationDate      DateTime                  @default(now())
  registrationMethod    String
  preferredLanguage     String                    @default("en")
  profilePhoto          String?
  status                String                    @default("new_convert")
  statusHistory         Json                      @default("[]")
  biometricId           String?
  
  // Community assignments
  cellCommunityId       String?
  ministryId            String?
  professionCommunityId String?
  tribeId               String?
  
  // Preferences
  privacyLevel          String                    @default("public")
  allowDirectoryListing Boolean                   @default(true)
  allowMessaging        Boolean                   @default(true)
  notificationPrefs     Json                      @default("{\"email\": true, \"sms\": true, \"push\": true}")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch                Branch?                   @relation(fields: [branchId], references: [id], onDelete: SetNull)
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cellCommunity         Community?                @relation("CellMembers", fields: [cellCommunityId], references: [id])
  ministry              Community?                @relation("MinistryMembers", fields: [ministryId], references: [id])
  professionCommunity   Community?                @relation("ProfessionMembers", fields: [professionCommunityId], references: [id])
  tribe                 Community?                @relation("TribeMembers", fields: [tribeId], references: [id])
  
  communityLeaderships  CommunityLeadership[]
  departmentAssignments DepartmentAssignment[]
  attendanceRecords     AttendanceRecord[]
  giveHistory           Transaction[]
  promotionRequests     PromotionRequest[]
  appraisals            Appraisal[]
  volunteerShifts       VolunteerShift[]
  surveyResponses       SurveyResponse[]
  directMessages        DirectMessage[]
  forumPosts            ForumPost[]
  badges                MemberBadge[]
  loyaltyPoints         LoyaltyPoints[]
  competitionScores     CompetitionScore[]
  // Chat relations
  directChatParticipantOne DirectChat[] @relation("DirectChatParticipantOne")
  directChatParticipantTwo DirectChat[] @relation("DirectChatParticipantTwo")
  communityChatParticipants CommunityChatParticipant[]
  chatMessages          ChatMessage[]
  messageReactions      MessageReaction[]
  
  @@unique([tenantId, memberId])
  @@index([tenantId])
  @@index([branchId])
  @@index([email])
  @@index([status])
}

// ============================================
// COMMUNITY MANAGEMENT
// ============================================

model Community {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  slug                  String
  description           String?
  type                  String
  category              String?
  location              String?
  geoArea               Json?
  activeStatus          Boolean                   @default(true)
  imageUrl              String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  cellMembers           Member[]                  @relation("CellMembers")
  ministryMembers       Member[]                  @relation("MinistryMembers")
  professionMembers     Member[]                  @relation("ProfessionMembers")
  tribeMembers          Member[]                  @relation("TribeMembers")
  
  leaders               CommunityLeadership[]
  meetings              CommunityMeeting[]
  forums                Forum[]
  competitionRounds     CompetitionRound[]
  // Chat relations
  communityChat         CommunityChat?
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([type])
}

model CommunityLeadership {
  id                    String                    @id @default(cuid())
  communityId           String
  memberId              String
  role                  String
  appointmentDate       DateTime                  @default(now())
  approvalDate          DateTime?
  approvedBy            String?
  status                String                    @default("pending")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  community             Community                 @relation(fields: [communityId], references: [id], onDelete: Cascade)
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([communityId, memberId, role])
  @@index([communityId])
  @@index([memberId])
}

model CommunityMeeting {
  id                    String                    @id @default(cuid())
  communityId           String
  title                 String
  description           String?
  venue                 String
  scheduledDate         DateTime
  duration              Int
  meetingType           String
  hostId                String
  maxAttendees          Int?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  community             Community                 @relation(fields: [communityId], references: [id], onDelete: Cascade)
  attendanceRecords     AttendanceRecord[]
  
  @@index([communityId])
  @@index([scheduledDate])
}

// ============================================
// SERVICE & EVENT MANAGEMENT
// ============================================

model Service {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  type                  String
  scheduledDate         DateTime
  duration              Int
  venue                 String?
  speaker               String?
  capacity              Int?
  status                String                    @default("scheduled")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendanceRecords     AttendanceRecord[]
  streamingSessions     StreamingSession[]
  
  @@index([tenantId])
  @@index([scheduledDate])
}

model Event {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  slug                  String
  description           String?
  eventType             String
  startDate             DateTime
  endDate               DateTime
  venue                 String
  location              String
  capacity              Int?
  status                String                    @default("upcoming")
  registrationOpen      Boolean                   @default(true)
  registrationDeadline  DateTime?
  maxRegistrations      Int?
  currentRegistrations  Int                       @default(0)
  imageUrl              String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  registrations         EventRegistration[]
  travelBookings        TravelBooking[]
  ticketings            EventTicket[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([startDate])
}

model EventRegistration {
  id                    String                    @id @default(cuid())
  eventId               String
  memberId              String
  registrationDate      DateTime                  @default(now())
  status                String                    @default("confirmed")
  specialRequests       String?
  dietaryRequirements   String?
  accessibilityNeeds    String?
  checkInTime           DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  event                 Event                     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, memberId])
  @@index([eventId])
  @@index([status])
}

// ============================================
// ATTENDANCE TRACKING
// ============================================

model AttendanceRecord {
  id                    String                    @id @default(cuid())
  memberId              String
  serviceId             String?
  meetingId             String?
  eventId               String?
  attendanceType        String
  checkInTime           DateTime
  checkOutTime          DateTime?
  checkInMethod         String
  isVirtual             Boolean                   @default(false)
  watchDuration         Int?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  service               Service?                  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  communityMeeting      CommunityMeeting?         @relation(fields: [meetingId], references: [id], onDelete: SetNull)
  
  @@index([memberId])
  @@index([checkInTime])
  @@index([serviceId])
}

// ============================================
// DEPARTMENT MANAGEMENT
// ============================================

model Department {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  slug                  String
  description           String?
  headId                String?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workers               DepartmentAssignment[]
  meetings              DepartmentMeeting[]
  activities            DepartmentActivity[]
  volunteerShifts       VolunteerShift[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
}

model DepartmentAssignment {
  id                    String                    @id @default(cuid())
  memberId              String
  departmentId          String
  role                  String
  assignmentDate        DateTime                  @default(now())
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  department            Department                @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  appraisals            Appraisal[]
  
  @@unique([memberId, departmentId])
  @@index([departmentId])
}

model DepartmentMeeting {
  id                    String                    @id @default(cuid())
  departmentId          String
  title                 String
  scheduledDate         DateTime
  venue                 String?
  duration              Int?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  department            Department                @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  @@index([departmentId])
}

model DepartmentActivity {
  id                    String                    @id @default(cuid())
  departmentId          String
  name                  String
  description           String?
  scheduledDate         DateTime
  status                String                    @default("planned")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  department            Department                @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  @@index([departmentId])
}

// ============================================
// PROMOTION & APPRAISAL WORKFLOW
// ============================================

model PromotionRequest {
  id                    String                    @id @default(cuid())
  memberId              String
  fromStatus            String
  toStatus              String
  requestDate           DateTime                  @default(now())
  submittedBy           String?
  status                String                    @default("pending")
  reviewedBy            String?
  reviewedAt            DateTime?
  rejectionReason       String?
  approvalDate          DateTime?
  cycleId               String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  evaluations           PromotionEvaluation[]
  
  @@index([memberId])
  @@index([status])
}

model PromotionEvaluation {
  id                    String                    @id @default(cuid())
  promotionRequestId    String
  evaluatorId           String
  evaluatorRole         String
  evaluationDate        DateTime                  @default(now())
  decision              String
  feedback              String?
  criteriaScores        Json
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  promotionRequest      PromotionRequest          @relation(fields: [promotionRequestId], references: [id], onDelete: Cascade)
  
  @@index([promotionRequestId])
}

model Appraisal {
  id                    String                    @id @default(cuid())
  memberId              String
  departmentAssignmentId String
  appraisalPeriod       String
  year                  Int
  performanceScore      Int?
  behaviorScore         Int?
  feedbackComments      String?
  appraiserComments     String?
  appraiserName         String?
  appraisalDate         DateTime?
  status                String                    @default("pending")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  departmentAssignment  DepartmentAssignment     @relation(fields: [departmentAssignmentId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
  @@index([year])
}

// ============================================
// VOLUNTEER MANAGEMENT
// ============================================

model VolunteerShift {
  id                    String                    @id @default(cuid())
  memberId              String
  departmentId          String
  shiftDate             DateTime
  startTime             DateTime
  endTime               DateTime
  role                  String
  assignedBy            String?
  status                String                    @default("scheduled")
  completionNotes       String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  department            Department                @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
  @@index([shiftDate])
}

// ============================================
// FINANCIAL MANAGEMENT
// ============================================

model Transaction {
  id                    String                    @id @default(cuid())
  tenantId              String
  memberId              String
  type                  String                    // offering, tithe, donation, pledge, event_payment, course_fee
  amount                Decimal                   @db.Decimal(10, 2)
  currency              String
  method                String                    // cash, card, transfer, check, mobile_money
  reference             String?                   // Payment reference
  status                String                    @default("completed")  // completed, pending, failed
  description           String?
  receiptId             String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  member                Member?                   @relation(fields: [memberId], references: [id], onDelete: SetNull)
  
  @@index([tenantId])
  @@index([memberId])
  @@index([createdAt])
  @@index([status])
}

model Pledge {
  id                    String                    @id @default(cuid())
  tenantId              String
  memberId              String
  amount                Decimal                   @db.Decimal(10, 2)
  pledgeDate            DateTime                  @default(now())
  dueDate               DateTime
  purpose               String?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  @@index([memberId])
}

model DonationReceipt {
  id                    String                    @id @default(cuid())
  transactionId         String
  receiptNumber         String                    @unique
  generatedAt           DateTime                  @default(now())
  
  @@index([transactionId])
}

// ============================================
// GAMIFICATION & LOYALTY
// ============================================

model LoyaltyProgram {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  description           String?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
}

model MemberBadge {
  id                    String                    @id @default(cuid())
  memberId              String
  name                  String
  description           String?
  iconUrl               String?
  awardedDate           DateTime                  @default(now())
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
}

model LoyaltyPoints {
  id                    String                    @id @default(cuid())
  memberId              String
  points                Int
  activity              String                    // attendance, volunteer, referral, donation
  expiryDate            DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
}

model CompetitionRound {
  id                    String                    @id @default(cuid())
  tenantId              String
  communityId           String
  name                  String
  description           String?
  competitionType       String                    // quiz, attendance_battle, volunteer_challenge
  startDate             DateTime
  endDate               DateTime
  status                String                    @default("upcoming")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  community             Community                 @relation(fields: [communityId], references: [id], onDelete: Cascade)
  scores                CompetitionScore[]
  
  @@index([tenantId])
  @@index([communityId])
}

model CompetitionScore {
  id                    String                    @id @default(cuid())
  roundId               String
  memberId              String
  score                 Int
  rank                  Int?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  round                 CompetitionRound          @relation(fields: [roundId], references: [id], onDelete: Cascade)
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([roundId, memberId])
  @@index([roundId])
}

// ============================================
// AI & CHATBOT MANAGEMENT
// ============================================

model AITraining {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  description           String?
  courseContent         Json?
  status                String                    @default("draft")      // draft, active, archived
  isMandatory           Boolean                   @default(true)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enrollments           AITrainingEnrollment[]
  
  @@index([tenantId])
}

model AITrainingEnrollment {
  id                    String                    @id @default(cuid())
  trainingId            String
  memberId              String
  enrollmentDate        DateTime                  @default(now())
  completionDate        DateTime?
  certificateIssued     Boolean                   @default(false)
  score                 Int?
  status                String                    @default("in_progress")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  training              AITraining                @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  
  @@unique([trainingId, memberId])
  @@index([trainingId])
  @@index([status])
}

model ChatbotConversation {
  id                    String                    @id @default(cuid())
  tenantId              String
  memberId              String
  topic                 String
  sentiment             String?
  resolved              Boolean                   @default(false)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages              ChatbotMessage[]
  
  @@index([tenantId])
  @@index([memberId])
}

model ChatbotMessage {
  id                    String                    @id @default(cuid())
  conversationId        String
  sender                String                    // user, bot
  message               String
  intent                String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  conversation          ChatbotConversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
}

// ============================================
// PRAYER & DISCUSSION
// ============================================

model PrayerRequest {
  id                    String                    @id @default(cuid())
  tenantId              String
  memberId              String
  title                 String
  description           String
  category              String?
  visibility            String                    @default("public")      // public, members_only, private
  prayerCount           Int                       @default(0)
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([memberId])
}

model Discussion {
  id                    String                    @id @default(cuid())
  tenantId              String
  title                 String
  prompt                String
  category              String?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
}

// ============================================
// BROADCASTING & STREAMING
// ============================================

model BroadcastSession {
  id                    String                    @id @default(cuid())
  tenantId              String
  title                 String
  description           String?
  streamUrl             String?
  startTime             DateTime
  endTime               DateTime?
  status                String                    @default("scheduled")  // scheduled, live, completed, cancelled
  viewCount             Int                       @default(0)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([startTime])
}

model StreamingSession {
  id                    String                    @id @default(cuid())
  serviceId             String
  streamUrl             String
  recordingUrl          String?
  viewCount             Int                       @default(0)
  startTime             DateTime
  endTime               DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  service               Service                   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@index([serviceId])
}

// ============================================
// PARTNERSHIPS
// ============================================

model Partner {
  id                    String                    @id @default(cuid())
  tenantId              String
  name                  String
  type                  String                    // vendor, sponsor, partner
  discount              Decimal?                  @db.Decimal(5, 2)      // percentage
  contactPerson         String?
  email                 String?
  phone                 String?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
}

// ============================================
// TRAVEL & EVENTS BOOKING
// ============================================

model TravelBooking {
  id                    String                    @id @default(cuid())
  eventId               String
  memberId              String
  destination           String
  departureDate         DateTime
  returnDate            DateTime
  accommodationType     String
  transportationType    String
  cost                  Decimal                   @db.Decimal(10, 2)
  status                String                    @default("pending")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  event                 Event                     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@index([eventId])
  @@index([memberId])
}

model EventTicket {
  id                    String                    @id @default(cuid())
  eventId               String
  ticketType            String
  price                 Decimal                   @db.Decimal(10, 2)
  quantityAvailable     Int
  quantitySold          Int                       @default(0)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  event                 Event                     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@index([eventId])
}

// ============================================
// COMMUNICATION
// ============================================

model DirectMessage {
  id                    String                    @id @default(cuid())
  senderId              String
  receiverId            String
  message               String
  isRead                Boolean                   @default(false)
  readAt                DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  sender                Member                    @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([receiverId])
  @@index([senderId])
}

// ============================================
// COMMUNITY FORUMS
// ============================================

model Forum {
  id                    String                    @id @default(cuid())
  communityId           String
  name                  String
  description           String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  community             Community                 @relation(fields: [communityId], references: [id], onDelete: Cascade)
  posts                 ForumPost[]
  
  @@index([communityId])
}

model ForumPost {
  id                    String                    @id @default(cuid())
  forumId               String
  memberId              String
  title                 String
  content               String
  likes                 Int                       @default(0)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  forum                 Forum                     @relation(fields: [forumId], references: [id], onDelete: Cascade)
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([forumId])
  @@index([memberId])
}

// ============================================
// SURVEYS & FEEDBACK
// ============================================

model Survey {
  id                    String                    @id @default(cuid())
  title                 String
  description           String?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
}

model SurveyResponse {
  id                    String                    @id @default(cuid())
  surveyId              String
  memberId              String
  responseData          Json
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([memberId])
}

// ============================================
// PWA & OFFLINE SUPPORT
// ============================================

model PWAInstallation {
  id                    String                    @id @default(cuid())
  userId                String                    @unique
  installationDate      DateTime                  @default(now())
  lastUsedAt            DateTime                  @default(now())
  deviceInfo            Json?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  @@index([userId])
}

model OfflineSyncQueue {
  id                    String                    @id @default(cuid())
  userId                String
  operationType         String                    // create, update, delete
  entityType            String                    // Member, Transaction, etc.
  entityId              String
  payloadData           Json
  synced                Boolean                   @default(false)
  syncedAt              DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  @@index([userId])
  @@index([synced])
}

// ============================================
// SECURITY & AUDIT
// ============================================

model APIToken {
  id                    String                    @id @default(cuid())
  userId                String
  token                 String                    @unique
  name                  String
  expiresAt             DateTime?
  lastUsedAt            DateTime?
  status                String                    @default("active")
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model AuditLog {
  id                    String                    @id @default(cuid())
  userId                String?
  adminId               String?
  action                String
  entityType            String
  entityId              String
  changes               Json?
  ipAddress             String?
  userAgent             String?
  status                String                    @default("success")    // success, failure
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  user                  User?                     @relation(fields: [userId], references: [id], onDelete: SetNull)
  admin                 SystemAdmin?              @relation(fields: [adminId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

model Notification {
  id                    String                    @id @default(cuid())
  userId                String
  title                 String
  message               String
  type                  String                    // email, sms, push, in_app
  isRead                Boolean                   @default(false)
  readAt                DateTime?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  user                  User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
}

// ============================================
// CHAT & MESSAGING SYSTEM
// ============================================

model DirectChat {
  id                    String                    @id @default(cuid())
  tenantId              String
  participantOneId      String
  participantTwoId      String
  lastMessageAt         DateTime?
  isArchivedByOne       Boolean                   @default(false)
  isArchivedByTwo       Boolean                   @default(false)
  isMutedByOne          Boolean                   @default(false)
  isMutedByTwo          Boolean                   @default(false)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  participantOne        Member                    @relation("DirectChatParticipantOne", fields: [participantOneId], references: [id], onDelete: Cascade)
  participantTwo        Member                    @relation("DirectChatParticipantTwo", fields: [participantTwoId], references: [id], onDelete: Cascade)
  messages              ChatMessage[]
  
  @@unique([tenantId, participantOneId, participantTwoId])
  @@index([tenantId])
  @@index([participantOneId])
  @@index([participantTwoId])
  @@index([lastMessageAt])
}

model CommunityChat {
  id                    String                    @id @default(cuid())
  tenantId              String
  communityId           String
  name                  String?                   // Optional custom name for the chat
  description           String?
  topic                 String?
  lastMessageAt         DateTime?
  lastMessageFrom       String?
  messageCount          Int                       @default(0)
  isArchived            Boolean                   @default(false)
  pinnedMessageId       String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  community             Community                 @relation(fields: [communityId], references: [id], onDelete: Cascade)
  messages              ChatMessage[]
  participants          CommunityChatParticipant[]
  
  @@unique([tenantId, communityId])
  @@index([tenantId])
  @@index([communityId])
  @@index([lastMessageAt])
}

model CommunityChatParticipant {
  id                    String                    @id @default(cuid())
  communityChatId       String
  memberId              String
  role                  String                    @default("member")       // admin, moderator, member
  joinedAt              DateTime                  @default(now())
  lastReadMessageId     String?
  lastReadAt            DateTime?
  isMuted                Boolean                   @default(false)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  communityChat         CommunityChat             @relation(fields: [communityChatId], references: [id], onDelete: Cascade)
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([communityChatId, memberId])
  @@index([communityChatId])
  @@index([memberId])
}

model ChurchWideChat {
  id                    String                    @id @default(cuid())
  tenantId              String
  branchId              String?                   // Optional: specific branch or null for all branches
  title                 String
  description           String?
  topic                 String?
  createdBy             String
  lastMessageAt         DateTime?
  lastMessageFrom       String?
  messageCount          Int                       @default(0)
  isArchived            Boolean                   @default(false)
  isPinned              Boolean                   @default(false)
  visibility            String                    @default("all")         // all, members_only, leadership_only, branch_specific
  allowedRoles          String[]                  @default([])            // Empty = all roles
  pinnedMessageId       String?
  isModerationEnabled   Boolean                   @default(true)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages              ChatMessage[]
  reports               ChatReport[]
  
  @@index([tenantId])
  @@index([branchId])
  @@index([visibility])
  @@index([lastMessageAt])
}

model BranchWideChat {
  id                    String                    @id @default(cuid())
  tenantId              String
  branchId              String
  title                 String
  description           String?
  topic                 String?
  createdBy             String
  lastMessageAt         DateTime?
  lastMessageFrom       String?
  messageCount          Int                       @default(0)
  isArchived            Boolean                   @default(false)
  isPinned              Boolean                   @default(false)
  visibility            String                    @default("all")         // all, members_only, leadership_only
  allowedRoles          String[]                  @default([])            // Empty = all roles
  pinnedMessageId       String?
  isModerationEnabled   Boolean                   @default(true)
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch                Branch                    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  messages              ChatMessage[]
  reports               BranchChatReport[]
  
  @@unique([tenantId, branchId, title])
  @@index([tenantId])
  @@index([branchId])
  @@index([visibility])
  @@index([lastMessageAt])
}

model ChatMessage {
  id                    String                    @id @default(cuid())
  tenantId              String
  senderId              String
  
  // Chat associations (exactly one should be populated)
  directChatId          String?
  communityChatId       String?
  branchWideChatId      String?
  churchWideChatId      String?
  
  content               String
  messageType           MessageType               @default(TEXT)
  status                MessageStatus             @default(SENT)
  
  // Media/Attachments
  mediaUrl              String?
  mediaType             String?                   // image, video, audio, file
  mediaSize             Int?
  fileUrl               String?
  fileName              String?
  
  // Message features
  isEdited              Boolean                   @default(false)
  editedAt              DateTime?
  editedBy              String?
  editHistory           Json[]                    @default([])
  
  isPinned              Boolean                   @default(false)
  pinnedAt              DateTime?
  pinnedBy              String?
  
  isForwarded           Boolean                   @default(false)
  forwardedFromId       String?
  
  quotedMessageId       String?
  quotedContent         String?
  
  // Moderation
  isFlagged             Boolean                   @default(false)
  flagReason            String?
  isHidden              Boolean                   @default(false)
  hiddenReason          String?
  
  // Reactions
  reactions             MessageReaction[]
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sender                Member                    @relation(fields: [senderId], references: [id], onDelete: Cascade)
  directChat            DirectChat?               @relation(fields: [directChatId], references: [id], onDelete: Cascade)
  communityChat         CommunityChat?            @relation(fields: [communityChatId], references: [id], onDelete: Cascade)
  branchWideChat        BranchWideChat?           @relation(fields: [branchWideChatId], references: [id], onDelete: Cascade)
  churchWideChat        ChurchWideChat?           @relation(fields: [churchWideChatId], references: [id], onDelete: Cascade)
  readReceipts          MessageReadReceipt[]
  
  @@index([tenantId])
  @@index([senderId])
  @@index([directChatId])
  @@index([communityChatId])
  @@index([branchWideChatId])
  @@index([churchWideChatId])
  @@index([createdAt])
  @@index([isHidden])
  @@index([isFlagged])
}

model MessageReadReceipt {
  id                    String                    @id @default(cuid())
  messageId             String
  readBy                String
  readAt                DateTime                  @default(now())
  
  // Relations
  message               ChatMessage               @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, readBy])
  @@index([messageId])
  @@index([readBy])
}

model MessageReaction {
  id                    String                    @id @default(cuid())
  tenantId              String
  messageId             String
  memberId              String
  reactionType          ReactionType
  customEmoji           String?
  
  createdAt             DateTime                  @default(now())
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  message               ChatMessage               @relation(fields: [messageId], references: [id], onDelete: Cascade)
  member                Member                    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([messageId, memberId, reactionType])
  @@index([tenantId])
  @@index([messageId])
  @@index([memberId])
}

model TypingIndicator {
  id                    String                    @id @default(cuid())
  tenantId              String
  memberId              String
  
  // Chat associations
  directChatId          String?
  communityChatId       String?
  branchWideChatId      String?
  churchWideChatId      String?
  
  isTyping              Boolean                   @default(true)
  expiresAt             DateTime                  // Auto-expire after 3 seconds
  
  createdAt             DateTime                  @default(now())
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([directChatId])
  @@index([communityChatId])
  @@index([branchWideChatId])
  @@index([churchWideChatId])
  @@index([expiresAt])
}

model ChatReport {
  id                    String                    @id @default(cuid())
  tenantId              String
  churchWideChatId      String
  reportedBy            String
  reason                String
  description           String?
  severity              String                    @default("low")         // low, medium, high, critical
  status                String                    @default("open")        // open, investigating, resolved, closed
  
  actionTaken           String?
  actionTakenBy         String?
  actionTakenAt         DateTime?
  notes                 String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  churchWideChat        ChurchWideChat            @relation(fields: [churchWideChatId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([churchWideChatId])
  @@index([status])
  @@index([severity])
}

model BranchChatReport {
  id                    String                    @id @default(cuid())
  tenantId              String
  branchWideChatId      String
  reportedBy            String
  reason                String
  description           String?
  severity              String                    @default("low")         // low, medium, high, critical
  status                String                    @default("open")        // open, investigating, resolved, closed
  
  actionTaken           String?
  actionTakenBy         String?
  actionTakenAt         DateTime?
  notes                 String?
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  tenant                Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branchWideChat        BranchWideChat            @relation(fields: [branchWideChatId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([branchWideChatId])
  @@index([status])
  @@index([severity])
}
